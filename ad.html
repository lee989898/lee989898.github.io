<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Coroutines</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->

    <!-- custom.css -->
    <link rel="stylesheet" type="text/css" href="/assets/built/custom.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- 웹 폰트 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/nanumgothic.css">

    <!-- syntax.css -->
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="공부 블로그" />
    <link rel="shortcut icon" href="https://lee989898.github.io/assets/built/images/favicon.jpg" type="image/png" />
    <link rel="canonical" href="https://lee989898.github.io/ad" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

    
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$'] ],
    processEscapes: true,
  }
});
MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
</script>
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

    


     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="LEE" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Coroutines" />
    <meta property="og:description" content="컴퓨터 과학에는 여러 동시 프로세스를 관리하는 두 가지 유형의 멀티태스킹 방법이 있다 한 종류로 운영 체제는 프로세스 간의 전환을 제어한다 다른 유형은 프로세스가 스스로 행동을 제어하는 ​​협력적 멀티태스킹이라고 한다 코루틴은 협력적 멀티태스킹을 위한 하위 루틴을 생성하는 소프트웨어 구성 요소이다 잘 관리되는 “sub-task”의 순서로. 코루틴은 경량 스레드로 간주될 수 있다 단일" />
    <meta property="og:url" content="https://lee989898.github.io/ad" />
    <meta property="og:image" content="https://lee989898.github.io/assets/built/images/android-logo.png" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2022-04-19T16:07:07+09:00" />
    <meta property="article:modified_time" content="2022-04-19T16:07:07+09:00" />
    <meta property="article:tag" content="Android" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Coroutines" />
    <meta name="twitter:description" content="컴퓨터 과학에는 여러 동시 프로세스를 관리하는 두 가지 유형의 멀티태스킹 방법이 있다 한 종류로 운영 체제는 프로세스 간의 전환을 제어한다 다른 유형은 프로세스가 스스로 행동을 제어하는 ​​협력적 멀티태스킹이라고 한다 코루틴은 협력적 멀티태스킹을 위한 하위 루틴을 생성하는 소프트웨어 구성 요소이다 잘 관리되는 “sub-task”의 순서로. 코루틴은 경량 스레드로 간주될 수 있다 단일" />
    <meta name="twitter:url" content="https://lee989898.github.io/" />
    <meta name="twitter:image" content="https://lee989898.github.io/assets/built/images/android-logo.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="LEE" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Android" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "LEE",
        "logo": "https://lee989898.github.io/"
    },
    "url": "https://lee989898.github.io/ad",
    "image": {
        "@type": "ImageObject",
        "url": "https://lee989898.github.io/assets/built/images/android-logo.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://lee989898.github.io/ad"
    },
    "description": "컴퓨터 과학에는 여러 동시 프로세스를 관리하는 두 가지 유형의 멀티태스킹 방법이 있다 한 종류로 운영 체제는 프로세스 간의 전환을 제어한다 다른 유형은 프로세스가 스스로 행동을 제어하는 ​​협력적 멀티태스킹이라고 한다 코루틴은 협력적 멀티태스킹을 위한 하위 루틴을 생성하는 소프트웨어 구성 요소이다 잘 관리되는 “sub-task”의 순서로. 코루틴은 경량 스레드로 간주될 수 있다 단일"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Coroutines" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://lee989898.github.io/">LEE</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-kotlin" role="menuitem"><a href="/tag/kotlin/">코틀린</a></li>
    <li class="nav-algorithm" role="menuitem"><a href="/tag/algorithm/">알고리즘</a></li>
    <li class="nav-pl" role="menuitem"><a href="/tag/pl/">프로그래밍언어</a></li>
    <li class="nav-android" role="menuitem"><a href="/tag/android/">안드로이드</a></li>
    <li class="nav-security" role="menuitem"><a href="/tag/security/">컴퓨터보안</a></li>
    <li class="nav-system" role="menuitem"><a href="/tag/system/">시스템프로그래밍</a></li>
    <li class="nav-systemcloud" role="menuitem"><a href="/tag/systemcloud/">시스템클라우드보안</a></li>
    <li class="nav-blockchain" role="menuitem"><a href="/tag/blockchain/">블록체인</a></li>
    <li class="nav-archive" role="menuitem">
        
        <a href="/archive.html">All Posts</a>
    </li>
    <li class="nav-archive" role="menuitem">
        <a href="/author_archive.html">Tag별 Posts</a>
    </li>


</ul>



        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
        </div>
        
            <a class="subscribe-button" href="#subscribe">Search</a>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-android post tag-android ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="19 April 2022">19 April 2022</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/android/'>ANDROID</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Coroutines</h1>
            </header>

            <!--
            
            <figure class="post-full-image" style="background-image: url(/assets/built/images/android-logo.png)">
            </figure>
            
            -->
            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>컴퓨터 과학에는 여러 동시 프로세스를 관리하는 두 가지 유형의 멀티태스킹 방법이 있다<br />
한 종류로 운영 체제는 프로세스 간의 전환을 제어한다<br />
다른 유형은 프로세스가 스스로 행동을 제어하는 ​​협력적 멀티태스킹이라고 한다</p>

<p>코루틴은 협력적 멀티태스킹을 위한 하위 루틴을 생성하는 소프트웨어 구성 요소이다<br />
잘 관리되는 “sub-task”의 순서로. 코루틴은 경량 스레드로 간주될 수 있다<br />
단일 스레드에서 많은 코루틴을 실행할 수 있다. 또 코루틴은 스레드 간에 전환될 수도 있다<br />
즉, 코루틴은 한 스레드에서 일시 중단되고 다른 스레드에서 재개될 수 있다</p>

<p>rxjava, asynctask에서의 고통스러운 멀티스레딩 작업 또는 executors, HandlerThreads 및 IntentServices을 Corotuine을 사용하여 쉽고 효율적으로 수행할 수 있다</p>

<p>Coroutines API를 사용하면 비동기식 코드를 순차적으로 작성할 수 있다<br />
불필요한 보일러 플레이트 코드를 피하는 Hense는 콜백과 함께 제공되며 코드를 더 읽기 쉽게 만든다</p>

<p>대부분의 스마트폰은 재생 빈도가 60hz 이상이다. 1000밀리초를 60으로 나누면 16.666.. 이 나온다<br />
따라서 앱은 스마트폰에서 실행되면 화면을 그려야 한다<br />
약 16초마다 메인 스레드를 사용한다</p>

<p>더 좋은 스마트폰은 90hz, 120hz와 같은 더 높은 재생 빈도를 가지고 있다<br />
전화기의 새로 고침 수준이 90hz인 경우 1000밀리초를 90으로 나누면 앱은 Android 메인 스레드에서 작업을 수행하는 데 11ms밖에 없다<br />
새로 고침 레벨이 120hz인 경우 1000은 120으로 나누면 8ms만 가질 가진다<br />
기본적으로 Android 메인 스레드에는 일련의 일반 책임이 있다. 항상 xml을 구문 분석하고 뷰 구성 요소를 확장하고 새로 고칠 때마다 계속해서 그려야 한다. 메인 스레드는 또한 클릭 이벤트와 같은 사용자 상호 작용을 처리해야 한다. 따라서 메인 스레드에 더 많은 작업을 추가하면 실행 시간이 다음과 같은 매우 작은 시간 간격을 초과하면 두 번 새로 고침하면 앱에 성능 오류가 표시되고, 화면이 멈출 수 있다. 그 결과 사용자는 예측할 수 없는 행동을 보게 된다. 또 View 컴포넌트에서, 응용 프로그램이 응답하지 않는 오류가 발생하기도 한다</p>

<p>기술 발전의 결과로 이러한 재생 빈도는 매년 점점 더 높아지고 있다<br />
따라서 안드로이드 개발자로서 우리는 항상 장기 실행 작업을 비동기적으로 실행하도록 노력해야 한다<br />
별도의 스레드에서 이를 달성하기 위해 오늘날 우리가 보유한 가장 효율적이고 효과적인 최신 기술이 코틀린 코루틴이다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MainActivity.kt</span>
<span class="kd">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">var</span> <span class="py">count</span> <span class="p">=</span> <span class="mi">0</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>

        <span class="n">btnCount</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>
            <span class="n">tvCount</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">count</span><span class="p">++.</span><span class="nf">toString</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">btnDownloadUserData</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>
            <span class="nf">downloadUserData</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">downloadUserData</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
            <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span> <span class="s">"Downloading user $i in ${Thread.currentThread().name}"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>위 코드에서 다운로드 버튼을 누르고 btnCount 버튼을 누르면 좀 이따가 실행된다. 앱이 잠시 멈춘것이다<br />
이 문제를 해결하기 위해 코루틴을 사용해야 한다. 먼저 dependency를 등록한다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// build.grdle</span>
<span class="nf">dependencies</span> <span class="p">{</span>
    <span class="n">implementation</span> <span class="err">'</span><span class="n">org</span><span class="p">.</span><span class="n">jetbrains</span><span class="p">.</span><span class="n">kotlinx</span><span class="p">:</span><span class="n">kotlinx-coroutines-android</span><span class="p">:</span><span class="mf">1.3.9</span><span class="err">'</span>
<span class="p">}</span>
</code></pre></div></div>

<p>CoroutineScope는 코루틴의 범위를 제공하는 인터페이스이다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MainActivity.kt</span>

<span class="kd">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">var</span> <span class="py">count</span> <span class="p">=</span> <span class="mi">0</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>

        <span class="n">btnCount</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>
            <span class="n">tvCount</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">count</span><span class="p">++.</span><span class="nf">toString</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">btnDownloadUserData</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>

            <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span>
                <span class="nf">downloadUserData</span><span class="p">()</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">downloadUserData</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
            <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span> <span class="s">"Downloading user $i in ${Thread.currentThread().name}"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>코루틴은 코루틴을 추적하거나 코루틴이 수행하는 작업을 추적하는 데 도움이 되지 않는다<br />
매우 신중하게 관리하지 않으면 메모리에 코루틴 누수가 발생할 수 있다<br />
리소스는 불필요하게 낭비되며 애플리케이션 성능에도 영향을 미친다</p>

<p>하지만 다행스럽게도 Kotlin 프로그래밍 언어 제작자는 이미 그 문제를 해결했다<br />
Kotlin 코루틴에서는 범위 내에서 모든 코루틴을 시작해야 한다. 우리는 쉽게 코루틴을 추적하고 코룬틴을 취소하고 오류 또는 예외를 처리할 수 있다<br />
CoroutineScope는 코루틴에 범위를 제공하는 데 사용한 인터페이스이다<br />
코틀린 코루틴에서 GlobalScope라는 또 다른 범위 인터페이스가 있다. 전역 범위는 최상위 코루틴을 시작하는 데 사용된다<br />
전체 응용 프로그램 수명 동안 작동하지만 안드로이드 개발에서 우리는 거의 사용하지 않는다</p>

<p>이 두 범위는 모두 코루틴 컨텍스트에 대한 참조 역할도 한다. Dispatchers.IO가 CoroutineScope의 컨텍스트이다<br />
명시적 작업 인스턴스를 사용하려는 경우 작업 인스턴스의 이름과 디스패처를 포함할 수 있다. 더하기 연산자는 여러 코루틴 컨텍스트를 병합하는 데 사용할 수 있다</p>

<p>Dispatcher는 코루틴이 있는 스레드의 종류를 설명한다. Kotlin Android 구조적 동시성에서는 항상 메인 스레드를 사용하여 코루틴을 시작한 다음 백그라운드 스레드로 전환하는 것이 좋다<br />
Dispatcher.Main을 사용한다, IO 디스패처도 있다. Dispatchers.IO, Dispatchers.Default 및 Dispatchers.Unconfined<br />
따라서 Dispatcher.Main 을 사용하면 코루틴이 메인 스레드에서 실행된다  Android에서는 UI 스레드라고도 한다. Main 또는 UI 스레드는 하나만 있다<br />
따라서 Dispatchers.Main을 컨텍스트로 사용하여 범위 내에서 10개의 코루틴을 생성하면 10개의 모든 코루틴은 동일한 메인 스레드에서 실행된다</p>

<p>우리는 UI 함수 호출, 일시 중단 호출과 같은 작고 가벼운 작업에만 기본 디스패처를 사용한다<br />
기능을 사용하거나 livedata에서 업데이트를 가져온다</p>

<p>항상 메인 스레드에서 코루틴을 시작하고 나중에 background 스레드로 전환</p>

<p>Dispatchers.IO를 사용하는 경우 코루틴은 주문형 공유 풀의 백그라운드 스레드에서 실행된다<br />
만들어진 스레드. 우리는 이 IO 디스패처를 사용하여 로컬 데이터베이스와 작업한다<br />
네트워크와 통신하고 파일 작업을 수행한다</p>

<p>Default 디스패처는 CPU 집약적인 작업에 사용된다<br />
예를 들어 10000개의 목록 항목으로 데이터 목록을 정렬하거나 100000개의 영화에 대한 세부 정보가 포함된 거대한 JSON 파일을 구문 분석한다</p>

<p>Dispatcher.Uncomfined는 GlobalScope와 함께 사용되는 디스패처이다<br />
Dispatchers.Unconfined Coroutine을 사용하면 현재 스레드에서 실행되지만 일시 중단되고 다시 시작되면 일시 중단 기능이 실행 중인 스레드에서 실행된다 사용하지 않는 것이 좋다. Android 개발용 디스패처이다</p>

<p>이 4개의 디스패처 코루틴 외에도 API는 실행자를 디스패처로 변환하는 것을 용이하게 한다<br />
뿐만 아니라 자신의 맞춤형 디스패처를 생성한다. room 및 retrofit과 같은 라이브러리 제작자는 별도의 백그라운드 스레드에서 작업을 실행하기 위해 자체 사용자 지정 디스패처를 사용한다</p>

<p>메인 디스패처에서 쉽게 사용할 수 있다. 스레드를 변경하는 코드를 작성하지 않고. 안드로이드 개발자로서 대부분의 경우 Dispatchers.Main 및 Dispathcers.IO를 사용한다</p>

<p>launch는 코루틴 빌더로 코루틴의 확장 기능이다. 새로운 코루틴을 시작하는 데 사용되는 범위. 네 가지 주요 코루틴 빌더. launch, async, produce 및 runblocking</p>

<p>Launch coroutine builder는 현재 스레드를 차단 없이 새로운 co 루틴을 시작한다<br />
이 빌더는 코루틴에 대한 참조로 사용할 수 있는 작업 인스턴스를 반환하고 그것을 사용할 수 있다<br />
반환된 작업 인스턴스를 사용하여 코루틴을 추적하고 코루틴을 취소할 수 있다. 코루틴에 런치 빌더를 사용하면 반환 값으로 결과가 없다. 이 빌더는 작업 인스턴스를 반환하지만 모든 계산 결과를 반환하지 않는다. 우리는 이 코루틴을 사용하여 무언가를 계산하고 반환된 값으로 최종 답을 얻을 수 없다</p>

<p>이러한 결과를 반환된 값으로 얻으려면 비동기 코루틴 빌더를 사용해야 한다. 뿐만 아니라 비동기 빌더의 주요 특징은 코루틴을 병렬로 시작할 수 있다는 것이다<br />
async 빌더 또한 현재 스레드를 차단하지 않고 새 코루틴을 시작한다<br />
이 빌더는 결과 유형의 지연된 인스턴스를 리턴한다. 실제로 지연된 인터페이스는 작업 인터페이스의 확장. 따라서 코루틴을 취소하는 작업에 대해 작업을 사용하는 것처럼 사용할 수 있다<br />
결과가 문자열 값인 경우 유형은 문자열이고 결과가 Int 값이면 이 유형은 Int이다<br />
지연된 객체에서 값을 얻으려면 wait() 함수를 호출해야 한다</p>

<p>안드로이드 개발 시작 및 비동기 빌더는 코루틴 빌더이다. 그러나 Produce 및 runBlocking 빌더도 있다. 프로듀스 빌더는 코루틴용이다<br />
요소 스트림을 생성하고 이 빌더는 ReceiveChannel의 인스턴스를 반환한다<br />
안드로이드 개발에서 우리는 주로 테스트를 위해 runblocking builder를 사용한다<br />
다른 코루틴과 달리, 이 빌더를 사용하여 생성한 코루틴은 실행이 끝날 때까지 스레드를 차단한다. 그리고 직접 사용할 수 있는 결과를 반환한다</p>

<p>백그라운드 스레드에서 ui 스레드에서 실행 중인 뷰 구성 요소를 직접 호출할 수 없다. 실행하면 이제 CalledFromWrongThreadException 표시가 나온다<br />
뷰 계층 구조를 만든 원래 스레드만 해당 뷰를 접근할 수 있다<br />
따라서 UI 스레드에서 뷰를 호출해야 한다. 하지만 코루틴에는 전환하는 가장 쉬운 방법이 있다<br />
스레드 사이. 컨텍스트 기능과 함께 사용하면 한 스레드에서 다른 스레드로 코루틴을 전환할 수 있다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MainActivity.kt</span>
<span class="kd">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">var</span> <span class="py">count</span> <span class="p">=</span> <span class="mi">0</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>

        <span class="n">btnCount</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>
            <span class="n">tvCount</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">count</span><span class="p">++.</span><span class="nf">toString</span><span class="p">()</span>


        <span class="p">}</span>
        <span class="n">btnDownloadUserData</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>

            <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span>
                <span class="nf">downloadUserData</span><span class="p">()</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">downloadUserData</span><span class="p">()</span> <span class="p">{</span>

            <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">Main</span><span class="p">){</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tvUserMessage</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="s">"Downloading user $i in ${Thread.currentThread().name}"</span>
                    <span class="nf">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>kotlin 코루틴에서 코루틴이 일시 중단될 때마다 함수의 현재 스택 프레임이 복사되어 메모리에 저장된다<br />
이후에 기능이 재개될 때 임무를 완수하고, 스택 프레임은 저장된 위치에서 다시 복사되고 다시 실행되기 시작한다<br />
Kotlin 코루틴 API는 작업을 더 쉽게 만들어주는 많은 기능을 제공한다. 거의 기능을 일시 중단하는것<br />
withContext(), withTimeout(), withTimeoutOrNull(), Join(), delay(), await(), supervisorScope, coroutineScope<br />
많은 일시 중단 기능이 있다<br />
코루틴 라이브러리 뿐만 아니라, room 및 retroift과 같은 다른 라이브러리도 일할 수 있도록 지원하는 일시 중단 기능을 제공한다</p>

<p>코루틴으로. 함수에서 함수를 일시 중단하는 첫 번째 클래스를 호출하려는 경우 suspend modifier로 함수를 표시해야 한다<br />
withContext와 같은 일시 중단 함수를 사용하려면 호출 함수를 표시해야 한다. suspend modifiter와 함께<br />
또한 우리가 만든 다른 일시 중단 함수를 호출하려면 suspend 수정자를 사용하여 함수를 호출한다. suspending modifier로 실제로 함수의 사용을 제한하고 있다<br />
코루틴에만 해당한다. suspending 함수는 코루틴 블록에서 호출할 수 있다. 또는 다른 일시 중단 기능에서만<br />
일반 함수 또는 다른 위치에서 일시 중단 함수를 호출할 수 없다<br />
실제로 suspend modifier를 사용하여 함수에 장기 실행 작업이 많은 함수라는 레이블을 지정한다
코루틴은 일시 중단 함수와 일반 함수를 모두 호출할 수 있지만 suspending 함수는 코루틴만 인 것을 기억하자</p>

<p>Suspending Functions의 작동</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">myFunction</span><span class="p">(){</span>

<span class="nc">Code</span> <span class="n">block</span> <span class="mi">1</span>

<span class="nc">Code</span> <span class="n">block</span> <span class="mi">2</span> <span class="c1">//this one has a long running operation</span>

<span class="nc">Code</span> <span class="n">block</span> <span class="mi">3</span>

<span class="nc">Code</span> <span class="n">block</span> <span class="mi">4</span>

<span class="p">}</span>
</code></pre></div></div>

<p>일반적으로 위 코드에서 코드 블록은 block1, block2, block3, block4 처럼 실행된다 따라서 코드 블록 3과 4는 코드 블록 3이 계속 실행되는 동안 실행될 수 있다. (동기적으로) 거기에서 문제가 있을 수 있다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">MyFunction</span><span class="p">(){</span>

<span class="nc">Code</span> <span class="n">block</span> <span class="mi">1</span>

<span class="nc">Code</span> <span class="n">block</span> <span class="mi">2</span> <span class="c1">//this one has a long running operation</span>

<span class="nc">Code</span> <span class="n">block</span> <span class="mi">3</span>

<span class="nc">Code</span> <span class="n">block</span> <span class="mi">4</span>

<span class="p">}</span>
</code></pre></div></div>

<p>이제 이 함수는 코드 블록 2(장기 실행 작업)이 시작될 때 일시 중지되고 완료되면 다시 시작할 수 있다. 코드 블록 3과 4는 그 후에 실행된다. 따라서 예기치 않은 스레드 공유 문제가 발생한다</p>

<p>suspend 키워드로 표시된 함수는 소스 코드에서 동기적으로 나타나더라도 컴파일 시간에 변환되어 내부에서 비동기화된다</p>

<p>일시 중단 함수는 스레드를 차단하지 않는다<br />
그러나 코루틴 자체만 일시 중단합니다. (하나의 스레드가 더 많은 코루틴을 가질 수 있음)<br />
코루틴이 기다리는 동안 스레드는 풀로 반환된다. 대기가 완료되면 코루틴은 풀의 여유 스레드에서 재개된다</p>

<p>4개의 온라인 데이터 소스에서 결과를 가져와 모두 결합하여 사용자에게 최종 결과를 제공한다고 할 떄 첫 번째 작업은 10초 소요, 두 번째 작업은 15초 소요, 세 번째 작업은 12초, 그리고 네 번째 작업은 13초가 걸린다<br />
이러한 데이터 세트를 하나씩 다운로드하는 코드를 쉽게 작성할 수 있다<br />
하지만 그렇게 하면 사용자는 최종 결과를 보기 위해 최소 50초를 기다려야 한다<br />
일부 사용자는 화를 내며 앱을 제거할 수 있다</p>

<p>이 모든 데이터를 병렬로 다운로드할 수 있다면 어떨까?<br />
만약에 우리가 할 수 있다면 단 15초 만에 결과를 표시할 수 있다<br />
이러한 데이터를 병렬로 다운로드하고 마지막에 결합하는 코드를 작성하는 것을 parallel 이라고 한다<br />
Parallel Decomposition은 그러헥 쉽지 않다. 이를 위해 복잡하고 길고 읽기 어렵고 유지 관리하기 어려운 코드를 작성해야 했다<br />
그러나 Kotlin 코루틴을 사용하면 쉽다</p>

<p>먼저 순차분해이다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MainActivity.kt</span>
<span class="kd">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>

        <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">IO</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span><span class="s">"Calculation started...."</span><span class="p">)</span>

            <span class="kd">val</span> <span class="py">stock1</span> <span class="p">=</span> <span class="nf">getStock1</span><span class="p">()</span>
            <span class="kd">val</span> <span class="py">stock2</span> <span class="p">=</span> <span class="nf">getStock2</span><span class="p">()</span>

            <span class="kd">val</span> <span class="py">total</span> <span class="p">=</span> <span class="n">stock1</span><span class="p">+</span><span class="n">stock2</span>

            <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span><span class="s">"Total is $total"</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getStock1</span><span class="p">()</span> <span class="p">:</span> <span class="nc">Int</span> <span class="p">{</span>
    <span class="nf">delay</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
    <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span><span class="s">" stock 1 returned "</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">55000</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getStock2</span><span class="p">()</span> <span class="p">:</span> <span class="nc">Int</span> <span class="p">{</span>
    <span class="nf">delay</span><span class="p">(</span><span class="mi">8000</span><span class="p">)</span>
    <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span><span class="s">" stock 2 returned "</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">35000</span>
<span class="p">}</span>
</code></pre></div></div>

<p>asyc를 활용해서 병렬로 해보자<br />
대부분의 경우. 코루틴 launch builder 작업을 반환하고 asyc 코루틴 빌더는 Deferred의 값을 반환한다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MainActivity.kt</span>
<span class="kd">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>

        <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">IO</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span><span class="s">"Calculation started...."</span><span class="p">)</span>

            <span class="kd">val</span> <span class="py">stock1</span> <span class="p">=</span> <span class="nf">async</span> <span class="p">{</span>
                <span class="nf">getStock1</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="kd">val</span> <span class="py">stock2</span> <span class="p">=</span> <span class="nf">async</span> <span class="p">{</span>
                <span class="nf">getStock2</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="kd">val</span> <span class="py">total</span> <span class="p">=</span> <span class="n">stock1</span><span class="p">.</span><span class="nf">await</span><span class="p">()+</span><span class="n">stock2</span><span class="p">.</span><span class="nf">await</span><span class="p">()</span>

            <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span><span class="s">"Total is $total"</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getStock1</span><span class="p">()</span> <span class="p">:</span> <span class="nc">Int</span> <span class="p">{</span>
    <span class="nf">delay</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
    <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span><span class="s">" stock 1 returned "</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">55000</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getStock2</span><span class="p">()</span> <span class="p">:</span> <span class="nc">Int</span> <span class="p">{</span>
    <span class="nf">delay</span><span class="p">(</span><span class="mi">8000</span><span class="p">)</span>
    <span class="nc">Log</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"MyTag"</span><span class="p">,</span><span class="s">" stock 2 returned "</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">35000</span>
<span class="p">}</span>
</code></pre></div></div>

<p>병렬 분해 덕분에 비동기 빌더와 await 함수 호출을 사용하여 구현했다<br />
위 코드에서 IO 스레드 풀에 속하는 백그라운드 스레드에서 코루틴을 시작하고 모든 병렬 작업을 수행했다</p>

<p>구조적 동시성을 적용해 보자<br />
그전에 먼저 구조화 되지 않은 동시성을 보자</p>

<p>일시 중단 함수에서 동시에 둘 이상의 코루틴을 사용하고 일부 결과를 반환한다<br />
두 가지 방법이 있다. 그것들을 구조적 동시성과 비구조적 동시성이라고 부른다<br />
먼저 구조화되지 않은 동시성에 대해 보자. 이것은 잘못된 방법이다</p>

<p>UserDataManager1 클래스를 만들고 result를 사용하여 계산된 int 값을 반환하는 일시 중단 함수를 만든다
두 개의 동시 작업 중. MainActivity에서 새 일시 중단 함수를 호출하고 반환된 값을 텍스트뷰에 넣는다<br />
IO 디스패처에서 새 코루틴을 시작한다. 장기 실행 작업을 시뮬레이션하려면 이 코루틴을 1초 동안 지연시킨다<br />
그런 다음 count 변수에 값 50을 설정해 보겠다. 마지막으로 우리는 반환한다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// UserDataManager.kt</span>
<span class="kd">class</span> <span class="nc">UserDataManager</span> <span class="p">{</span>

    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getTotalUserCount</span><span class="p">():</span> <span class="nc">Int</span><span class="p">{</span>
        <span class="kd">var</span> <span class="py">count</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="nf">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">count</span> <span class="p">=</span> <span class="mi">50</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">count</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>이제 MainActivity로 다시 전환해 보겠습니다. 여기 MainActivity에서 이 클릭 이벤트를 사용하여 반환된 카운트 값을 표시할 수 있다<br />
또한 코루틴의 디스패처를 Main으로 변경해야 한다. 그렇지 않으면 텍스트 보기에 값을 표시할 수 없다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MainActivity.kt</span>
<span class="n">btnDownloadUserData</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>

            <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span>
                <span class="n">tvUserMessage</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="nc">UserDataManager</span><span class="p">().</span><span class="nf">getTotalUserCount</span><span class="p">().</span><span class="nf">toString</span><span class="p">()</span>
            <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>이 앱을 실행하면 반환된 값으로 0을 얻는다. 반환된 값은 50이어야 한다. 하지만 0을 받았다<br />
여기에서 이 코루틴 범위는 새 코루틴을 만든다. 이는 MainActivity에서 이 상위 코루틴과 별도로 작동한다<br />
따라서 이 함수는 끝에 도달하고 완료되기 전에 이 카운트 변수의 값을 반환한다. 그 이유 때문에 50 대신 0을 얻었다<br />
이것이 비구조화의 약점이다<br />
구조화되지 않은 동시성 일시 중단 기능의 모든 작업을 완료하는 것을 보장하지 않으며, 돌아오기 전에. 실제로 자식 코루틴은 부모 코루틴이 완료된 후에도 계속 실행될 수 있다.launch 코루틴 빌더를 사용하는 경우 그 결과 예측할 수 없는 오류가 발생할 수 있다</p>

<p>그러나 asyn 빌더를 사용하고 반환 값에 대해 await 함수 호출을 사용하는 경우 비동기 코루틴의 예상 결과를 얻을 수 있다<br />
이제 비동기 빌더를 사용하여 다른 코루틴을 실행해보자<br />
70을 반환합시다. 비동기 블록에서 반환하기 때문에 return 대신 return@async를 사용한다<br />
이게 구조화되지 않은 동시성이 괜찮다는 것을 의미하는가? 아직 문제가 있다<br />
Android에서 함수에 오류가 발생하면 함수는 예외를 throw한다. 따라서 호출자 함수에서 예외를 포착하고 상황을 처리할 수 있다. 구조화되지 않은 동시성에서  launch 또는 async 빌더를 사용하던간에 예외를 적절하게 처리하는 방법을 알고 있다. 따라서 일부 시나리오에서는 잘 작동하는 것처럼 보이지만 구조화되지 않은
동시성이 있다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// UserDataManger.kt</span>
<span class="kd">class</span> <span class="nc">UserDataManager</span> <span class="p">{</span>

    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getTotalUserCount</span><span class="p">():</span> <span class="nc">Int</span><span class="p">{</span>
        <span class="kd">var</span> <span class="py">count</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="nf">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">count</span> <span class="p">=</span> <span class="mi">50</span>
        <span class="p">}</span>

        <span class="kd">val</span> <span class="py">deferred</span> <span class="p">=</span> <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">).</span><span class="nf">async</span> <span class="p">{</span>
            <span class="nf">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
            <span class="k">return</span><span class="nd">@async</span> <span class="mi">70</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">count</span> <span class="p">+</span> <span class="n">deferred</span><span class="p">.</span><span class="nf">await</span><span class="p">()</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>이 코루틴 범위 기능으로 위 문제를 해결할 수 있다. 대문자 ‘C’가 있는 CoroutineScope가 아니라 coroutineScope이다<br />
CoroutineScope 인터페이스를 사용하여 코루틴을 생성/실행하는 대신, 새로운 일시 중단 기능 내에서 coroutineScope 일시 중단 기능을 사용하여 자식을 제공한다<br />
자식 범위 내에서 비동기 빌더 실행을 사용할 수 있다. 런치 코루틴 빌더를 직접 사용하여 코루틴을 시작할 수 있다<br />
여기에 디스패처를 추가하지 않으면 이 코루틴은 상위 범위의 디스패처에서 시작된다. 따라서 부모 범위에는 Dispatchers.Main이 있다<br />
여기에서 어떤 Dispatcher에서도 사용하지 않으려면 이 코루틴은 메인 스레드에서 실행된다<br />
인터페이스는 반환 전에 제공한 자식 범위 내의 모든 작업 완료를 보장한다<br />
따라서 일단 이 get total user count 함수를 호출하면 호출자에게 반환되기 전에 이 범위 내에서 시작된 모든 코루틴이 완료된다</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// UserDataManger2.kt</span>
<span class="kd">class</span> <span class="nc">UserDataManager2</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="py">count</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">deferred</span><span class="p">:</span> <span class="nc">Deferred</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getTotalUserCount</span><span class="p">():</span> <span class="nc">Int</span> <span class="p">{</span>
        <span class="nf">coroutineScope</span> <span class="p">{</span>
            <span class="nf">launch</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">count</span> <span class="p">=</span> <span class="mi">50</span>
            <span class="p">}</span>

            <span class="n">deferred</span> <span class="p">=</span> <span class="nf">async</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
                <span class="k">return</span><span class="nd">@async</span> <span class="mi">70</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">count</span> <span class="p">+</span> <span class="n">deferred</span><span class="p">.</span><span class="nf">await</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MainActivity.kt</span>
<span class="n">btnDownloadUserData</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>

            <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">Main</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span>
                <span class="n">tvUserMessage</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="nc">UserDataManager2</span><span class="p">().</span><span class="nf">getTotalUserCount</span><span class="p">().</span><span class="nf">toString</span><span class="p">()</span>
            <span class="p">}</span>

        <span class="p">}</span>
</code></pre></div></div>

<p>실행해보면 suspending 함수가 제대로 작동하는것을 볼 수 있다</p>

<p>자, 여기 ‘c’ 로 시작하는 이 coroutineScope 기능 MainActivity에서 생성된 상위 범위의 제어 하에 있는 하위 범위를 가질 수 있다<br />
따라서 이것이 권장되는 모범 사례이다. 하나 이상의 코루틴이 있는 경우 항상 Dispatchers.Main으로 시작해야 한다. 항상 CoroutineScope 인터페이스로 시작해야 한다 그리고 내부 일시 중단 기능 coroutineScope 기능을 사용해야한다. 간단한 ‘c’로 시작하며 자식 scope를 제공한다<br />
그래서 이것은 구조화된 동시성이다. 시작된 모든 작업을 완료하기 위한 구조적 동시성 보장, 일시 중단 기능이 반환되기 전에 자식 범위 내에서 코루틴에 의해. 실제로 이 코루틴스코프 자식 코루틴이 완료될 때까지 기다린다<br />
뿐만 아니라 이 구조화된 동시성의 다른 이점이 있다. 오류가 발생하고 예외가 발생하면 구조화된 동시성이 호출자에게 알리도록 보장한다. 그래서 우리는 예외를 쉽고 효과적으로 처리할 수 있다<br />
또한 구조화된 동시성을 사용하여 취소할 수 있다. 전체 자식 범위를 취소하면 해당 범위 내에서 발생하는 모든 작업이 취소된다. 코루틴을 별도로 취소할 수도 있다</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            <!--
            
                <section class="subscribe-form">
                    <h3 class="subscribe-form-title">Subscribe to LEE</h3>
                    <p>Get the latest posts delivered right to your inbox</p>
                    <span id="searchform" method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  />
    <input class="location" type="hidden" name="location"  />
    <input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" onkeyup="myFunc()"
               id="searchtext" type="text" name="searchtext"
               placeholder="Search..." />
    </div>
    <script type="text/javascript">
        function myFunc() {
            if(event.keyCode == 13) {
                var url = encodeURIComponent($("#searchtext").val());
                location.href = "/search.html?query=" + url;
            }
        }
    </script>
</span>
                </section>
            
            -->


            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/built/images/author-logo.jpg" alt="lee989898" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/lee989898">lee989898</a></h4>
                                
                                    <p><a href="https://github.com/lee989898">깃허브</a></p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/lee989898">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            var this_page_url = 'https://lee989898.github.io/ad';
                            var this_page_identifier = '/ad';
                            var this_page_title = 'Coroutines';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://xxxxxxxx.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/built/images/blog-cover1.png)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; LEE &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/android/">Android</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/ad">RecyclerView</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/ad">Navigation Architecture Component</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/ad">View Model & Live Data with Data Binding</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/android/">
                                
                                    See all 12 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/ad">
                <div class="post-card-image" style="background-image: url(/assets/built/images/android-logo.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/ad">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Android</span>
                            
                        
                    

                    <h2 class="post-card-title">RecyclerView</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>RecyclerView 에 대해 알아보자
Android RecyclerView 라이브러리는 ListView, GridView보다 메모리 효율성이 더 수준 높은 버전으로 도입되었다

</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/built/images/author-logo.jpg" alt="lee989898" />
                        
                        <span class="post-card-author">
                            <a href="/author/lee989898/">lee989898</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      4 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://lee989898.github.io/">
            
            <span>LEE</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Coroutines</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Coroutines&amp;url=https://lee989898.github.io/ad"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://lee989898.github.io/ad"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://lee989898.github.io/">LEE</a> &copy; 2022</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyllt/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    
    <div id="subscribe" class="subscribe-overlay">
        <a class="subscribe-overlay-close" href="#"></a>
        <div class="subscribe-overlay-content">
            
            <h1 class="subscribe-overlay-title">Search LEE</h1>
            <p class="subscribe-overlay-description">
                lunr.js를 이용한 posts 검색 </p>
            <span id="searchform" method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  />
    <input class="location" type="hidden" name="location"  />
    <input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" onkeyup="myFunc()"
               id="searchtext" type="text" name="searchtext"
               placeholder="Search..." />
    </div>
    <script type="text/javascript">
        function myFunc() {
            if(event.keyCode == 13) {
                var url = encodeURIComponent($("#searchtext").val());
                location.href = "/search.html?query=" + url;
            }
        }
    </script>
</span>
        </div>
    </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-xxxxxxxx-x', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
